<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Draw a moving GeoJSON point</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/pouchdb/6.4.3/pouchdb.min.js'></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<div id='map'></div>
<script>

mapboxgl.accessToken = 'pk.eyJ1IjoiZnVhZGFndXNzYWxpbSIsImEiOiJjbGcyZ2Q1ZXMwMHZ2M2RuMW9uOHZ0cDNoIn0.odEIHnmRUwKd2wUq_nBowQ';
const REMOTE_DB = 'http://fuad:12345@localhost:5984/kotugo_bk';
var db = new PouchDB(REMOTE_DB);

var map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/light-v9',
  center: [-92.466, 44.0214],
  zoom: 16
});

// Load normal and transparent icon for blinking
map.loadImage('olli-icon.png', (error, image) => {
  if (error) {
    throw error;
  } else {
    map.addImage('olli-icon', image);
    // Create a transparent icon for blinking
    var canvas = document.createElement('canvas');
    canvas.width = image.width;
    canvas.height = image.height;
    var ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    var transparentImage = { width: image.width, height: image.height, data: ctx.getImageData(0, 0, canvas.width, canvas.height).data };
    map.addImage('olli-icon-blink', canvas, { pixelRatio: 1 });
  }
});

function updateAllCarsOnMap() {
  db.allDocs({ include_docs: true }).then(result => {
    const features = result.rows
      .map(row => row.doc)
      .filter(doc => doc.geometry && doc.properties && doc.properties.car_id)
      .map(doc => ({
        type: 'Feature',
        geometry: doc.geometry,
        properties: doc.properties
      }));
    const geojson = {
      type: 'FeatureCollection',
      features: features
    };
    map.getSource('olli-location').setData(geojson);
  });
}

var blinkState = true;
function setBlinkingIcon() {
  if (!map.getLayer('olli-location')) return;
  map.setLayoutProperty('olli-location', 'icon-image', blinkState ? 'olli-icon' : 'olli-icon-blink');
  blinkState = !blinkState;
}

map.on('load', function () {
  map.addLayer({
    'id': 'olli-location',
    'type': 'symbol',
    'source': {
      'type': 'geojson',
      'data': { type: 'FeatureCollection', features: [] }
    },
    'layout': {
      'icon-image': 'olli-icon',
      'icon-size': 1
    }
  });

  // Initial load
  updateAllCarsOnMap();

  // Listen for changes and update all cars
  db.changes({
    since: 'now',
    live: true,
    include_docs: true
  })
  .on('change', change => {
    console.log("Got a change...");
    updateAllCarsOnMap();
  })
  .on('error', err => {
    console.log(err);
  });

  // Blinking effect every 500ms
  // setInterval(setBlinkingIcon, 5000);
});

</script>

</body>
</html>